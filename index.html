<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AWorld Ultimate</title>

<style>
body{margin:0;overflow:hidden;font-family:Arial;background:#111;color:white}
canvas{display:block;background:#3a9d5d}
#ui{
position:absolute;top:10px;left:10px;
background:rgba(0,0,0,.8);padding:10px;
border-radius:10px;width:260px
}
button,input,select{width:100%;padding:6px;margin:4px 0}
.hidden{display:none}
#popup{
position:absolute;bottom:20px;left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,.9);padding:15px;
border-radius:10px;width:320px;text-align:center
}
.hint{font-size:12px;color:#ccc}
</style>
</head>

<body>

<div id="ui">
<div id="login">
<h2>AWorld</h2>
<input id="name" placeholder="Player name">
<select id="grade">
<option value="">Grade</option>
<option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option>
</select>
<button onclick="start()">Start</button>
</div>

<div id="hud" class="hidden">
<div id="stats"></div>
<div class="hint">Move: WASD ¬∑ Interact: E</div>
<button onclick="openShop()">üé® Skins</button>
<button onclick="teacher()">üë©‚Äçüè´ Teacher</button>
</div>
</div>

<canvas id="game"></canvas>
<div id="popup" class="hidden"></div>

<script>
/* ================= SAVE ================= */
let save = JSON.parse(localStorage.getItem("aworld")) || {
name:"",grade:3,xp:0,level:1,coins:0,skin:"cyan",story:0
};
const saveGame=()=>localStorage.setItem("aworld",JSON.stringify(save));

/* ================= AUDIO ================= */
let music=new Audio("https://actions.google.com/sounds/v1/ambiences/wind_chimes.ogg");
music.loop=true; music.volume=.3;
let sfx=new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

/* ================= LOGIN ================= */
function start(){
if(!name.value||!grade.value) return alert("Fill all fields");
save.name=name.value;
save.grade=parseInt(grade.value);
saveGame();
login.classList.add("hidden");
hud.classList.remove("hidden");
updateHUD();
music.play();
init();
}

function updateHUD(){
stats.innerHTML=
`üë§ ${save.name}<br>
üéì Grade ${save.grade}<br>
‚≠ê Level ${save.level}<br>
‚ö° XP ${save.xp}/${save.level*100}<br>
ü™ô Coins ${save.coins}<br>
üìñ Story ${save.story}/3`;
}

/* ================= GAME ================= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let player={x:200,y:200,s:22};
let cam={x:0,y:0};
let keys={},popupOpen=false;
const map={w:2000,h:2000};

onkeydown=e=>keys[e.key.toLowerCase()]=true;
onkeyup=e=>keys[e.key.toLowerCase()]=false;

/* ================= WORLD ================= */
const zones=[
{x:600,y:400,type:"add"},
{x:900,y:500,type:"fraction"},
{x:1200,y:600,type:"algebra"}
];

const npcs=[
{x:300,y:300,text:"Welcome! Solve math to grow stronger.",step:0},
{x:900,y:900,text:"You're learning fast!",step:1},
{x:1500,y:1200,text:"You mastered AWorld!",step:2}
];

/* ================= LOOP ================= */
function init(){ requestAnimationFrame(loop); }

function loop(){
ctx.clearRect(0,0,canvas.width,canvas.height);

/* movement */
if(keys.w)player.y-=4;
if(keys.s)player.y+=4;
if(keys.a)player.x-=4;
if(keys.d)player.x+=4;

/* bounds */
player.x=Math.max(0,Math.min(map.w,player.x));
player.y=Math.max(0,Math.min(map.h,player.y));

/* camera */
cam.x=player.x-canvas.width/2;
cam.y=player.y-canvas.height/2;

ctx.save();
ctx.translate(-cam.x,-cam.y);

/* ground */
ctx.fillStyle="#3a9d5d";
ctx.fillRect(0,0,map.w,map.h);

/* zones */
zones.forEach(z=>{
ctx.fillStyle="orange";
ctx.fillRect(z.x,z.y,40,40);
if(near(z)&&keys.e) openMinigame(z.type);
});

/* NPCs */
npcs.forEach(n=>{
ctx.fillStyle="pink";
ctx.fillRect(n.x,n.y,30,30);
if(near(n)&&keys.e&&save.story===n.step) talk(n.text);
});

/* player */
ctx.fillStyle=save.skin;
ctx.fillRect(player.x,player.y,player.s,player.s);

ctx.restore();
requestAnimationFrame(loop);
}

/* ================= MINIGAMES ================= */
function openMinigame(type){
if(popupOpen) return;
popupOpen=true; sfx.play();
let a=r(),b=r(),q,ans;

if(type==="add"){q=`${a}+${b}`;ans=a+b;}
if(type==="fraction"){q=`${a}/${b}`;ans=(a/b).toFixed(2);}
if(type==="algebra"){q=`x+4=${a+4}`;ans=a;}

popup.innerHTML=`
<h3>${type.toUpperCase()}</h3>
${q}<br><br>
<input id="ans">
<button onclick="
if(ans.value==${JSON.stringify(ans)}){
reward(); save.story++;
closePop();
}else alert('Try again!');
">Submit</button>`;
popup.classList.remove("hidden");
}

/* ================= NPC ================= */
function talk(text){
if(popupOpen) return;
popupOpen=true;
popup.innerHTML=`<p>${text}</p><button onclick="save.story++;closePop()">OK</button>`;
popup.classList.remove("hidden");
}

/* ================= REWARD ================= */
function reward(){
save.xp+=20;
save.coins+=5;
if(save.xp>=save.level*100){
save.xp-=save.level*100;
save.level++;
}
saveGame(); updateHUD();
}

/* ================= SHOP ================= */
function openShop(){
popupOpen=true;
popup.innerHTML=`
<h3>Skins</h3>
<button onclick="setSkin('cyan',0)">Cyan (Free)</button>
<button onclick="setSkin('yellow',10)">Yellow</button>
<button onclick="setSkin('red',10)">Red</button>
<button onclick="closePop()">Close</button>`;
popup.classList.remove("hidden");
}
function setSkin(c,cost){
if(cost&&save.coins<cost) return alert("Not enough coins");
save.coins-=cost||0; save.skin=c;
saveGame(); updateHUD();
}

/* ================= TEACHER ================= */
function teacher(){
popupOpen=true;
popup.innerHTML=`
<h3>Teacher Mode</h3>
<p>Level: ${save.level}<br>XP: ${save.xp}<br>Coins: ${save.coins}</p>
<button onclick="resetGame()">Reset</button>
<button onclick="closePop()">Close</button>`;
popup.classList.remove("hidden");
}
function resetGame(){
if(confirm("Reset progress?")){
localStorage.removeItem("aworld");
location.reload();
}
}

/* ================= UTIL ================= */
function closePop(){popup.classList.add("hidden");popupOpen=false;}
function r(){return Math.floor(Math.random()*save.grade*5)+1;}
function near(o){return Math.hypot(player.x-o.x,player.y-o.y)<40;}
</script>

</body>
</html>
