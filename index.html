<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWorld Ultimate</title>

<style>
body{margin:0;background:#111;color:white;font-family:Arial;overflow:hidden;}
canvas{background:#3a9d5d;display:block;}
#ui{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.8);padding:10px;border-radius:10px;width:260px}
button,input,select{width:100%;margin:4px 0;padding:6px}
.hidden{display:none}
#popup{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.9);padding:15px;border-radius:10px;width:320px;text-align:center}
</style>
</head>

<body>

<div id="ui">
<div id="login">
<h2>AWorld</h2>
<input id="name" placeholder="Player name">
<select id="grade">
<option value="">Grade</option>
<option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option>
</select>
<button onclick="start()">Start</button>
</div>

<div id="hud" class="hidden">
<div id="stats"></div>
<button onclick="openShop()">üé® Skins</button>
<button onclick="teacher()">üë©‚Äçüè´ Teacher Mode</button>
</div>
</div>

<canvas id="game"></canvas>
<div id="popup" class="hidden"></div>

<script>
/* ===== SAVE ===== */
let save=JSON.parse(localStorage.getItem("aworldU"))||{
name:"",grade:3,xp:0,level:1,coins:0,skin:"cyan",story:0
};
function saveGame(){localStorage.setItem("aworldU",JSON.stringify(save));}

/* ===== AUDIO ===== */
const beep=new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
const win=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const music=new Audio("https://actions.google.com/sounds/v1/ambiences/wind_chimes.ogg");
music.loop=true;

/* ===== LOGIN ===== */
function start(){
if(!name.value||!grade.value)return alert("Fill all");
save.name=name.value;
save.grade=parseInt(grade.value);
saveGame();
login.classList.add("hidden");
hud.classList.remove("hidden");
music.volume=0.3; music.play();
updateHUD(); init();
}

function updateHUD(){
stats.innerHTML=
`üë§ ${save.name}<br>
üéì Grade ${save.grade}<br>
‚≠ê Level ${save.level}<br>
‚ö° XP ${save.xp}<br>
ü™ô Coins ${save.coins}<br>
üìñ Story ${save.story}/3`;
}

/* ===== GAME ===== */
const c=document.getElementById("game"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;
let cam={x:0,y:0};
let player={x:200,y:200,s:22};
let keys={},busy=false;

const map={w:2000,h:2000};

/* ===== NPCs + STORY ===== */
const npcs=[
{x:300,y:300,text:"Welcome hero! Finish 3 math challenges.",quest:0},
{x:800,y:600,text:"Great job! Keep learning.",quest:1},
{x:1400,y:900,text:"You mastered AWorld!",quest:2}
];

/* ===== ZONES ===== */
const zones=[
{x:600,y:400,type:"add"},
{x:900,y:500,type:"fraction"},
{x:1200,y:600,type:"algebra"}
];

/* ===== LOOP ===== */
function init(){
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;
loop();
}

function loop(){
ctx.clearRect(0,0,c.width,c.height);

/* move */
if(keys.w)player.y-=4;
if(keys.s)player.y+=4;
if(keys.a)player.x-=4;
if(keys.d)player.x+=4;

/* camera follow */
cam.x=player.x-c.width/2;
cam.y=player.y-c.height/2;

/* bounds */
player.x=Math.max(0,Math.min(map.w,player.x));
player.y=Math.max(0,Math.min(map.h,player.y));

ctx.save();
ctx.translate(-cam.x,-cam.y);

/* ground */
ctx.fillStyle="#3a9d5d";
ctx.fillRect(0,0,map.w,map.h);

/* zones */
zones.forEach(z=>{
ctx.fillStyle="orange";
ctx.fillRect(z.x,z.y,40,40);
if(dist(player,z)<30)minigame(z.type);
});

/* NPCs */
npcs.forEach(n=>{
ctx.fillStyle="pink";
ctx.fillRect(n.x,n.y,30,30);
if(dist(player,n)<30&&save.story===n.quest)talk(n.text);
});

/* player */
ctx.fillStyle=save.skin;
ctx.fillRect(player.x,player.y,player.s,player.s);

ctx.restore();
requestAnimationFrame(loop);
}

/* ===== MINIGAMES ===== */
function minigame(type){
if(busy)return; busy=true; beep.play();
let a=r(),b=r(),q,ans;
if(type==="add"){q=`${a}+${b}`;ans=a+b;}
if(type==="fraction"){q=`${a}/${b}`;ans=(a/b).toFixed(2);}
if(type==="algebra"){q=`x+5=${a+5}`;ans=a;}

popup.innerHTML=`
<h3>${type.toUpperCase()}</h3>
${q}<br><br>
<input id="ans">
<button onclick="
if(ans.value==${JSON.stringify(ans)}){
win.play();
save.xp+=20;save.coins+=5;
if(save.xp>=save.level*100){save.xp=0;save.level++;}
save.story++;
saveGame();updateHUD();
closePop();
}else alert('Try again!');
">Submit</button>`;
popup.classList.remove("hidden");
}

/* ===== NPC TALK ===== */
function talk(text){
if(busy)return; busy=true;
popup.innerHTML=`<p>${text}</p><button onclick="closePop()">OK</button>`;
popup.classList.remove("hidden");
}

/* ===== SHOP / SKINS ===== */
function openShop(){
busy=true;
popup.innerHTML=`
<h3>Skins</h3>
<button onclick="skin('cyan')">Cyan (free)</button>
<button onclick="skin('yellow')">Yellow (10 coins)</button>
<button onclick="skin('red')">Red (10 coins)</button>
<button onclick="closePop()">Close</button>`;
popup.classList.remove("hidden");
}

function skin(c){
if(c!=="cyan"&&save.coins<10)return alert("Need coins!");
if(c!=="cyan")save.coins-=10;
save.skin=c;saveGame();updateHUD();}

/* ===== TEACHER MODE ===== */
function teacher(){
busy=true;
popup.innerHTML=`
<h3>Teacher Mode</h3>
<p>Level: ${save.level}<br>XP: ${save.xp}<br>Coins: ${save.coins}</p>
<button onclick="resetGame()">Reset Progress</button>
<button onclick="closePop()">Close</button>`;
popup.classList.remove("hidden");
}

function resetGame(){
if(confirm("Reset all progress?")){
localStorage.removeItem("aworldU");
location.reload();
}
}

/* ===== UTIL ===== */
function closePop(){popup.classList.add("hidden");busy=false;}
function r(){return Math.floor(Math.random()*save.grade*5)+1;}
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
</script>

</body>
</html>
